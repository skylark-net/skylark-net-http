/**
 * skylark-net-http - The skylark http  library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-types","skylark-langx-objects","skylark-langx-arrays","skylark-langx-async/deferred","skylark-langx-emitter/evented","./xhr","./http"],function(e,_,n,t,s,c,i){var f=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice,o=s.inherit({klassName:"Upload",_construct:function(e){this._options=_.mixin({debug:!1,url:"/upload",headers:{},maxConnections:999,maxChunkSize:void 0,onProgress:function(e,t,n,s){},onComplete:function(e,t,n,s,i){},onCancel:function(e,t){},onFailure:function(e,t,n){}},e),this._queue=[],this._params=[],this._files=[],this._xhrs=[],this._loaded=[]},add:function(e){return this._files.push(e)-1},send:function(e,t){var n;!this._files[e]||-1<this._queue.indexOf(e)||(n=this._queue.push(e),t=_.clone(t),this._params[e]=t,n<=this._options.maxConnections&&this._send(e,this._params[e]))},sendAll:function(e){for(var t=0;t<this._files.length;t++)this.send(t,e)},cancel:function(e){this._cancel(e),this._dequeue(e)},cancelAll:function(){for(var e=0;e<this._queue.length;e++)this._cancel(this._queue[e]);this._queue=[]},getName:function(e){e=this._files[e];return null!=e.fileName?e.fileName:e.name},getSize:function(e){e=this._files[e];return null!=e.fileSize?e.fileSize:e.size},getLoaded:function(e){return this._loaded[e]||0},_send:function(s,i){var o,e,t=this._options,a=this.getName(s),l=this.getSize(s),n=t.maxChunkSize||0,u=0,r=this._files[s],h={headers:_.clone(t.headers)},t=(this._loaded[s]=this._loaded[s]||0,this._xhrs[s]=new c({url:t.url})),d=(n?(h.data=f.call(r,this._loaded[s],this._loaded[s]+n,r.type),o=h.data.size,h.headers["content-range"]="bytes "+this._loaded[s]+"-"+(this._loaded[s]+o-1)+"/"+l,h.headers["Content-Type"]="application/octet-stream"):(o=l,n=i.formParamName,e=i.formData,n?((e=e||new FormData).append(n,r),h.data=e):(h.headers["Content-Type"]=r.type||"application/octet-stream",h.data=r)),this);t.post(h).progress(function(e){e.lengthComputable&&(u+=e.loaded,d._loaded[s]=d._loaded[s]+e.loaded,d._options.onProgress(s,a,d._loaded[s],l))}).then(function(e,t,n){d._files[s]&&(u<o&&(d._loaded[s]=d._loaded[s]+o-u,d._options.onProgress(s,a,d._loaded[s],l)),d._loaded[s]<l?d._send(s,i):(d._options.onComplete(s,a,e,t,n),d._files[s]=null,d._xhrs[s]=null,d._dequeue(s)))}).catch(function(e){d._options.onFailure(s,a,e),d._files[s]=null,d._xhrs[s]=null,d._dequeue(s)})},_cancel:function(e){this._options.onCancel(e,this.getName(e)),this._files[e]=null,this._xhrs[e]&&(this._xhrs[e].abort(),this._xhrs[e]=null)},getQueue:function(){return this._queue},_dequeue:function(e){var e=n.inArray(e,this._queue),t=(this._queue.splice(e,1),this._options.maxConnections);this._queue.length>=t&&e<t&&(e=this._queue[t-1],this._send(e,this._params[e]))}});return o.send=function(e,t){var n=new o(t),e=n.add(e);return n.send(e,t)},o.sendAll=function(e,t){for(var n=new o(t),s=0,i=e.length;s<i;s++)this.add(file[s]);return n.send(t)},i.Upload=o});
//# sourceMappingURL=sourcemaps/upload.js.map
