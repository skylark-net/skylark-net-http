/**
 * skylark-net-http - The skylark http  library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-types","skylark-langx-objects","skylark-langx-arrays","skylark-langx-async/Deferred","skylark-langx-emitter/Evented","./Xhr","./http"],function(e,t,n,i,s,o,l){var a=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice,u=s.inherit({klassName:"Upload",_construct:function(e){this._options=t.mixin({debug:!1,url:"/upload",maxConnections:999,maxChunkSize:void 0,onProgress:function(e,t,n,i){},onComplete:function(e,t){},onCancel:function(e,t){},onFailure:function(e,t,n){}},e),this._queue=[],this._params=[],this._files=[],this._xhrs=[],this._loaded=[]},add:function(e){return this._files.push(e)-1},send:function(e,n){if(this._files[e]&&!(this._queue.indexOf(e)>-1)){var i=this._queue.push(e),s=t.clone(n);this._params[e]=s,i<=this._options.maxConnections&&this._send(e,this._params[e])}},sendAll:function(e){for(var t=0;t<this._files.length;t++)this.send(t,e)},cancel:function(e){this._cancel(e),this._dequeue(e)},cancelAll:function(){for(var e=0;e<this._queue.length;e++)this._cancel(this._queue[e]);this._queue=[]},getName:function(e){var t=this._files[e];return null!=t.fileName?t.fileName:t.name},getSize:function(e){var t=this._files[e];return null!=t.fileSize?t.fileSize:t.size},getLoaded:function(e){return this._loaded[e]||0},_send:function(e,t){var n,i=this._options,s=this.getName(e),l=this.getSize(e),u=i.maxChunkSize||0,h=0,r=this._files[e],_={header:{"Content-Disposition":'attachment; filename="'+encodeURI(s)+'"',"Content-Type":r.type||"application/octet-stream"}};this._loaded[e]=this._loaded[e]||0;var d=this._xhrs[e]=new o({url:i.url});u?(_.data=a.call(r,this._loaded[e],this._loaded[e]+u,r.type),n=_.data.size,_.header["content-rrange"]="bytes "+this._loaded[e]+"-"+(this._loaded[e]+n-1)+"/"+l):(n=l,_.data=r);var c=this;d.post(_).progress(function(t){t.lengthComputable&&(h+=t.loaded,c._loaded[e]=c._loaded[e]+t.loaded,c._options.onProgress(e,s,c._loaded[e],l))}).then(function(){c._files[e]&&(h<n&&(c._loaded[e]=c._loaded[e]+n-h,c._options.onProgress(e,s,c._loaded[e],l)),c._loaded[e]<l?c._send(e,t):(c._options.onComplete(e,s),c._files[e]=null,c._xhrs[e]=null,c._dequeue(e)))}).catch(function(t){c._options.onFailure(e,s,t),c._files[e]=null,c._xhrs[e]=null,c._dequeue(e)})},_cancel:function(e){this._options.onCancel(e,this.getName(e)),this._files[e]=null,this._xhrs[e]&&(this._xhrs[e].abort(),this._xhrs[e]=null)},getQueue:function(){return this._queue},_dequeue:function(e){var t=qq.indexOf(this._queue,e);this._queue.splice(t,1);var n=this._options.maxConnections;if(this._queue.length>=n&&t<n){var i=this._queue[n-1];this._send(i,this._params[i])}}});return l.Upload=u});
//# sourceMappingURL=sourcemaps/Upload.js.map
